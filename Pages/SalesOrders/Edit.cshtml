@page
@model InventorySystem.Pages.SalesOrders.EditModel
@{
    ViewData["Title"] = "Edit Sales Order";
}

<div class="row">
    <div class="col-md-10 offset-md-1">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-pencil-square"></i> Edit Sales Order</h5>
            </div>
            <div class="card-body">
                <form method="post" id="editSalesOrderForm">
                    <div asp-validation-summary="All" class="text-danger mb-3"></div>

                    <input asp-for="SalesOrder.Id" type="hidden" />
                    <input asp-for="SalesOrder.OrderNumber" type="hidden" />

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Order Number</label>
                            <p class="form-control-plaintext"><strong>@Model.SalesOrder.OrderNumber</strong></p>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Original Order Date</label>
                            <p class="form-control-plaintext mb-2">@Model.SalesOrder.OrderDate.ToString("yyyy-MM-dd HH:mm")</p>

                            <label class="form-label">Changed Order Date</label>
                            <input class="form-control" type="datetime-local" value="@DateTime.Now.ToString("yyyy-MM-ddTHH:mm")" disabled />
                            <span class="form-text text-muted">The system will apply the current date/time when you save changes.</span>
                        </div>
                    </div>

                    <!-- Customer details: Name, Email, Phone -->
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label asp-for="SalesOrder.CustomerName" class="form-label">Customer Name</label>
                            <input asp-for="SalesOrder.CustomerName" class="form-control" />
                            <span asp-validation-for="SalesOrder.CustomerName" class="text-danger"></span>
                        </div>
                        <div class="col-md-4">
                            <label asp-for="SalesOrder.CustomerEmail" class="form-label">Email</label>
                            <input asp-for="SalesOrder.CustomerEmail" class="form-control" />
                            <span asp-validation-for="SalesOrder.CustomerEmail" class="text-danger"></span>
                        </div>
                        <div class="col-md-4">
                            <label asp-for="SalesOrder.CustomerPhone" class="form-label">Phone</label>
                            <input asp-for="SalesOrder.CustomerPhone" class="form-control" />
                            <span asp-validation-for="SalesOrder.CustomerPhone" class="text-danger"></span>
                        </div>
                    </div>

                    <div class="card mt-4 mb-4">
                        <div class="card-header bg-light">
                            <h5 class="mb-0"><i class="bi bi-box-seam"></i> Order Items</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered" id="itemsTable">
                                    <thead>
                                        <tr>
                                            <th style="width: 40%;">Product</th>
                                            <th style="width: 15%;">Unit Price</th>
                                            <th style="width: 12%;">Quantity</th>
                                            <th style="width: 12%;">Available</th>
                                            <th style="width: 20%;">Total</th>
                                            <th style="width: 5%;">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="itemsBody">
                                        <!-- rows populated by JS -->
                                    </tbody>
                                </table>
                            </div>

                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="addProductRow()">
                                <i class="bi bi-plus-circle"></i> Add Product Row
                            </button>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label asp-for="SalesOrder.Notes" class="form-label"></label>
                        <textarea asp-for="SalesOrder.Notes" class="form-control" rows="3"></textarea>
                        <span asp-validation-for="SalesOrder.Notes" class="text-danger"></span>
                    </div>

                    <div class="d-flex justify-content-between">
                        <a asp-page="./Details" asp-route-id="@Model.SalesOrder.Id" class="btn btn-secondary">
                            <i class="bi bi-arrow-left"></i> Back
                        </a>
                        <button type="submit" class="btn btn-primary"><i class="bi bi-save"></i> Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        let rowCount = 0;
        // include available quantity in the serialized products
        const products = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
            Model.Products.Select(p => new { id = p.Id, name = p.Name, sku = p.SKU, unitPrice = p.UnitPrice, quantity = p.QuantityInStock })
        ));
        const initialItems = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
            Model.Items.Select(i => new { productId = i.ProductId, quantity = i.Quantity, unitPrice = i.UnitPrice })
        ));

        document.addEventListener('DOMContentLoaded', function() {
            if (initialItems && initialItems.length > 0) {
                initialItems.forEach(it => addProductRow(it));
            } else {
                addProductRow();
            }
        });

        function addProductRow(initial = null) {
            const itemsBody = document.getElementById('itemsBody');
            const rowIndex = rowCount++;

            const row = document.createElement('tr');
            row.id = 'row_' + rowIndex;

            let productOptions = '<option value="">-- Select Product --</option>';
            products.forEach(product => {
                productOptions += `<option value="${product.id}" data-price="${product.unitPrice}" data-qty="${product.quantity}">${product.name} (SKU: ${product.sku || 'N/A'})</option>`;
            });

            const unitPriceVal = initial ? (initial.unitPrice ?? 0).toFixed(2) : '0.00';
            const quantityVal = initial ? (initial.quantity ?? 0) : 0;
            const productVal = initial ? initial.productId : '';

            row.innerHTML = `
                <td>
                    <select class="form-select form-select-sm product-select"
                            name="Items[${rowIndex}].ProductId"
                            onchange="onProductChange(${rowIndex})">
                        ${productOptions}
                    </select>
                </td>
                <td>
                    <input type="number" class="form-control form-control-sm unit-price"
                           name="Items[${rowIndex}].UnitPrice"
                           step="0.01" min="0" value="${unitPriceVal}"
                           onchange="updateRowTotal(${rowIndex})"
                           placeholder="0.00">
                </td>
                <td>
                    <input type="number" class="form-control form-control-sm quantity"
                           name="Items[${rowIndex}].Quantity"
                           min="0" value="${quantityVal}"
                           onchange="updateRowTotal(${rowIndex})"
                           placeholder="0">
                </td>
                <td class="text-center available-cell">
                    <input type="text" class="form-control form-control-sm available-input" readonly />
                </td>
                <td>
                    <input type="text" class="form-control form-control-sm row-total"
                           readonly
                           value="$0.00"
                           style="background-color: #f5f5f5;">
                </td>
                <td class="text-center">
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeProductRow(${rowIndex})">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            `;

            itemsBody.appendChild(row);

            // set product selection and initial totals after append
            if (productVal) {
                const select = row.querySelector('.product-select');
                select.value = productVal;
                const selected = products.find(p => p.id === productVal);
                if (selected) {
                    // available = current stock for pending orders (edit allowed only when Pending)
                    row.querySelector('.available-input').value = selected.quantity;
                }
            }

            updateRowTotal(rowIndex);
        }

        function removeProductRow(rowIndex) {
            const row = document.getElementById('row_' + rowIndex);
            if (row) {
                row.remove();
                calculateTotal();
            }
        }

        function onProductChange(rowIndex) {
            const row = document.getElementById('row_' + rowIndex);
            if (!row) return;
            const productSelect = row.querySelector('.product-select');
            const unitPriceInput = row.querySelector('.unit-price');
            const availableInput = row.querySelector('.available-input');

            const productId = parseInt(productSelect.value);
            if (productId) {
                const product = products.find(p => p.id === productId);
                if (product) {
                    unitPriceInput.value = product.unitPrice.toFixed(2);
                    availableInput.value = product.quantity;
                } else {
                    availableInput.value = '';
                }
            } else {
                availableInput.value = '';
            }

            updateRowTotal(rowIndex);
        }

        function updateRowTotal(rowIndex) {
            const row = document.getElementById('row_' + rowIndex);
            if (!row) return;

            const unitPriceInput = row.querySelector('.unit-price');
            const quantityInput = row.querySelector('.quantity');
            const rowTotalInput = row.querySelector('.row-total');

            const unitPrice = parseFloat(unitPriceInput.value) || 0;
            const quantity = parseInt(quantityInput.value) || 0;

            const rowTotal = unitPrice * quantity;
            rowTotalInput.value = '$' + rowTotal.toFixed(2);

            calculateTotal();
        }

        function calculateTotal() {
            let total = 0;
            const rows = document.querySelectorAll('#itemsBody tr');

            rows.forEach(row => {
                const rowTotalText = row.querySelector('.row-total').value;
                const rowTotal = parseFloat(rowTotalText.replace('$', '')) || 0;
                total += rowTotal;
            });
        }
    </script>
}