@page
@model InventorySystem.Pages.SalesOrders.CreateModel
@{
    ViewData["Title"] = "Create Sales Order";
}

<div class="row">
    <div class="col-md-10 offset-md-1">
        <div class="card">
            <div class="card-header">
                <h3><i class="bi bi-plus-circle"></i> Create New Sales Order</h3>
            </div>
            <div class="card-body">
                <form method="post" id="createOrderForm">
                    <!-- Customer Details Section -->
                    <div class="card mb-4 border-0 bg-light">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0"><i class="bi bi-person"></i> Customer Details</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label asp-for="SalesOrder.CustomerName" class="form-label"></label>
                                    <input asp-for="SalesOrder.CustomerName" class="form-control" placeholder="Enter customer name" required />
                                    <span asp-validation-for="SalesOrder.CustomerName" class="text-danger"></span>
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label asp-for="SalesOrder.CustomerEmail" class="form-label"></label>
                                    <input asp-for="SalesOrder.CustomerEmail" class="form-control" type="email" placeholder="Enter customer email" />
                                    <span asp-validation-for="SalesOrder.CustomerEmail" class="text-danger"></span>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label asp-for="SalesOrder.CustomerPhone" class="form-label"></label>
                                    <input asp-for="SalesOrder.CustomerPhone" class="form-control" placeholder="Enter customer phone" />
                                    <span asp-validation-for="SalesOrder.CustomerPhone" class="text-danger"></span>
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label asp-for="SalesOrder.OrderDate" class="form-label"></label>
                                    <input asp-for="SalesOrder.OrderDate" class="form-control" type="date" required />
                                    <span asp-validation-for="SalesOrder.OrderDate" class="text-danger"></span>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label asp-for="SalesOrder.Notes" class="form-label"></label>
                                <textarea asp-for="SalesOrder.Notes" class="form-control" rows="2" placeholder="Enter order notes (optional)"></textarea>
                                <span asp-validation-for="SalesOrder.Notes" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Products Section -->
                    <div class="card mb-4 border-0 bg-light">
                        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-box-seam"></i> Order Items</h5>
                            <button type="button" class="btn btn-sm btn-light" id="addRowBtn" onclick="addProductRow()">
                                <i class="bi bi-plus"></i> Add Product
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered" id="productsTable">
                                    <thead class="table-light">
                                        <tr>
                                            <th style="min-width: 200px;">Product</th>
                                            <th style="min-width: 120px;">Unit Price</th>
                                            <th style="min-width: 100px;">Quantity</th>
                                            <th style="min-width: 120px;">Available</th>
                                            <th style="min-width: 120px;">Total</th>
                                            <th style="width: 60px;">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="productsBody">
                                        <tr class="product-row" data-row="0">
                                            <td>
                                                <select class="form-select product-select" onchange="updateProductDetails(0)" required>
                                                    <option value="">-- Select Product --</option>
                                                    @foreach (var product in Model.Products)
                                                    {
                                                        <option value="@product.Id" data-price="@product.UnitPrice" data-stock="@product.QuantityInStock">
                                                            @product.Name (SKU: @product.SKU)
                                                        </option>
                                                    }
                                                </select>
                                            </td>
                                            <td>
                                                <input type="number" class="form-control unit-price" readonly />
                                            </td>
                                            <td>
                                                <input type="number" class="form-control quantity" min="1" onchange="updateRowTotal(0)" oninput="updateRowTotal(0)" required />
                                            </td>
                                            <td>
                                                <div class="input-group">
                                                    <input type="number" class="form-control available-stock" readonly />
                                                    <span class="input-group-text stock-status" style="background-color: #fff;"></span>
                                                </div>
                                            </td>
                                            <td>
                                                <input type="number" class="form-control row-total" step="0.01" readonly />
                                            </td>
                                            <td>
                                                <button type="button" class="btn btn-sm btn-danger" onclick="removeProductRow(0)">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <!-- Error Messages -->
                            <div id="stockValidationErrors" class="mt-3"></div>

                            <!-- Order Total -->
                            <div class="row mt-3">
                                <div class="col-md-8 text-end">
                                    <h5>Order Total:</h5>
                                </div>
                                <div class="col-md-4">
                                    <div class="input-group input-group-lg">
                                        <span class="input-group-text">$</span>
                                        <input type="number" class="form-control" id="orderTotal" step="0.01" readonly style="font-size: 1.25rem; font-weight: bold;" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="d-flex justify-content-between mb-3">
                        <a href="/SalesOrders" class="btn btn-secondary">
                            <i class="bi bi-arrow-left"></i> Back to List
                        </a>
                        <button type="submit" class="btn btn-success btn-lg" id="submitBtn">
                            <i class="bi bi-check-circle"></i> Create Order
                        </button>
                    </div>

                    <!-- Hidden field for items JSON -->
                    <input type="hidden" id="itemsJson" name="ItemsJson" />
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        let rowCounter = 1;
        const productData = @Html.Raw(Json.Serialize(Model.Products.ToDictionary(p => p.Id)));

        // Initialize date field to today
        document.addEventListener('DOMContentLoaded', function () {
            const dateInput = document.querySelector('input[name="SalesOrder.OrderDate"]');
            if (dateInput && !dateInput.value) {
                const today = new Date().toISOString().split('T')[0];
                dateInput.value = today;
            }
        });

        function addProductRow() {
            const tbody = document.getElementById('productsBody');
            const rowIndex = rowCounter++;
            const newRow = document.createElement('tr');
            newRow.className = 'product-row';
            newRow.setAttribute('data-row', rowIndex);
            newRow.innerHTML = `
                <td>
                    <select class="form-select product-select" onchange="updateProductDetails(${rowIndex})" required>
                        <option value="">-- Select Product --</option>
                        ${Object.values(productData).map(p =>
                            `<option value="${p.id}" data-price="${p.unitPrice}" data-stock="${p.quantityInStock}">
                                ${p.name} (SKU: ${p.sku})
                            </option>`
                        ).join('')}
                    </select>
                </td>
                <td>
                    <input type="number" class="form-control unit-price" readonly />
                </td>
                <td>
                    <input type="number" class="form-control quantity" min="1" onchange="updateRowTotal(${rowIndex})" oninput="updateRowTotal(${rowIndex})" required />
                </td>
                <td>
                    <div class="input-group">
                        <input type="number" class="form-control available-stock" readonly />
                        <span class="input-group-text stock-status" style="background-color: #fff;"></span>
                    </div>
                </td>
                <td>
                    <input type="number" class="form-control row-total" step="0.01" readonly />
                </td>
                <td>
                    <button type="button" class="btn btn-sm btn-danger" onclick="removeProductRow(${rowIndex})">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(newRow);
        }

        function removeProductRow(rowIndex) {
            const row = document.querySelector(`tr[data-row="${rowIndex}"]`);
            if (row) {
                row.remove();
                updateOrderTotal();
                clearStockErrors();
            }
        }

        function updateProductDetails(rowIndex) {
            const row = document.querySelector(`tr[data-row="${rowIndex}"]`);
            const selectElement = row.querySelector('.product-select');
            const selectedOption = selectElement.selectedOptions[0];

            if (selectedOption.value) {
                const price = parseFloat(selectedOption.getAttribute('data-price'));
                const stock = parseInt(selectedOption.getAttribute('data-stock'));

                row.querySelector('.unit-price').value = price.toFixed(2);
                row.querySelector('.available-stock').value = stock;
                row.querySelector('.quantity').value = '';
                row.querySelector('.row-total').value = '';

                // Update stock status indicator
                const stockStatus = row.querySelector('.stock-status');
                if (stock > 0) {
                    stockStatus.innerHTML = '✓ In Stock';
                    stockStatus.style.color = 'green';
                } else {
                    stockStatus.innerHTML = '✗ Out of Stock';
                    stockStatus.style.color = 'red';
                }
            } else {
                row.querySelector('.unit-price').value = '';
                row.querySelector('.available-stock').value = '';
                row.querySelector('.quantity').value = '';
                row.querySelector('.row-total').value = '';
                row.querySelector('.stock-status').innerHTML = '';
            }

            updateOrderTotal();
            clearStockErrors();
        }

        function updateRowTotal(rowIndex) {
            const row = document.querySelector(`tr[data-row="${rowIndex}"]`);
            const unitPrice = parseFloat(row.querySelector('.unit-price').value) || 0;
            const quantity = parseInt(row.querySelector('.quantity').value) || 0;
            const rowTotal = unitPrice * quantity;

            row.querySelector('.row-total').value = rowTotal.toFixed(2);
            updateOrderTotal();
        }

        function updateOrderTotal() {
            let total = 0;
            document.querySelectorAll('tr.product-row').forEach(row => {
                const rowTotal = parseFloat(row.querySelector('.row-total').value) || 0;
                total += rowTotal;
            });
            document.getElementById('orderTotal').value = total.toFixed(2);
        }

        function clearStockErrors() {
            document.getElementById('stockValidationErrors').innerHTML = '';
        }

        function validateStockBeforeSubmit() {
            clearStockErrors();
            const errors = [];
            let isValid = true;

            document.querySelectorAll('tr.product-row').forEach((row, index) => {
                const selectElement = row.querySelector('.product-select');
                const quantity = parseInt(row.querySelector('.quantity').value) || 0;
                const availableStock = parseInt(row.querySelector('.available-stock').value) || 0;
                const productName = selectElement.selectedOptions[0]?.text || 'Unknown Product';

                if (!selectElement.value) {
                    errors.push(`Row ${index + 1}: Please select a product`);
                    isValid = false;
                } else if (quantity === 0) {
                    errors.push(`Row ${index + 1}: Please enter a quantity`);
                    isValid = false;
                } else if (quantity > availableStock) {
                    errors.push(`${productName}: Only ${availableStock} units available, but ${quantity} requested`);
                    isValid = false;
                }
            });

            if (!isValid) {
                const errorHtml = `
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <i class="bi bi-exclamation-triangle"></i> <strong>Validation Errors:</strong>
                        <ul class="mb-0 mt-2">
                            ${errors.map(e => `<li>${e}</li>`).join('')}
                        </ul>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
                document.getElementById('stockValidationErrors').innerHTML = errorHtml;
            }

            return isValid;
        }

        document.getElementById('createOrderForm').addEventListener('submit', function (e) {
            if (!validateStockBeforeSubmit()) {
                e.preventDefault();
                return false;
            }

            // Prepare items JSON
            const items = [];
            document.querySelectorAll('tr.product-row').forEach(row => {
                const productId = row.querySelector('.product-select').value;
                const quantity = parseInt(row.querySelector('.quantity').value);
                const unitPrice = parseFloat(row.querySelector('.unit-price').value);

                if (productId && quantity > 0) {
                    items.push({
                        productId: parseInt(productId),
                        quantity: quantity,
                        unitPrice: unitPrice
                    });
                }
            });

            document.getElementById('itemsJson').value = JSON.stringify(items);
        });
    </script>
}
